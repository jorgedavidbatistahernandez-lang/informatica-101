let ordenActual = {
    columna: null,
    ascendente: true
};

/* =========================
   BUSCADOR
========================= */
document.getElementById("buscadorNombre").addEventListener("input", function () {
    const filtro = this.value.toLowerCase();
    document.querySelectorAll("#tablaAlumnos tbody tr").forEach(fila => {
        fila.style.display = fila.innerText.toLowerCase().includes(filtro) ? "" : "none";
    });
});

/* =========================
   ORDENAR TABLA
========================= */
document.querySelectorAll("#tablaAlumnos thead th").forEach((th, index) => {
    if (index < 3) {
        th.addEventListener("click", () => ordenarTabla(index));
    }
});

function ordenarTabla(columna) {
    const tbody = document.querySelector("#tablaAlumnos tbody");
    const filas = Array.from(tbody.querySelectorAll("tr"));

    if (ordenActual.columna === columna) {
        ordenActual.ascendente = !ordenActual.ascendente;
    } else {
        ordenActual.columna = columna;
        ordenActual.ascendente = true;
    }

    filas.sort((a, b) => {
        let aVal = a.children[columna].innerText.trim();
        let bVal = b.children[columna].innerText.trim();

        if (!isNaN(aVal) && !isNaN(bVal)) {
            return ordenActual.ascendente ? aVal - bVal : bVal - aVal;
        }

        return ordenActual.ascendente
            ? aVal.localeCompare(bVal, 'es')
            : bVal.localeCompare(aVal, 'es');
    });

    tbody.innerHTML = "";
    filas.forEach(f => tbody.appendChild(f));
}

/* =========================
   MODAL
========================= */
function abrirModal(alumno) {
    document.getElementById("modal").style.display = "block";
    document.getElementById("tituloAlumno").innerText = alumno.nombre;

    const detalle = document.getElementById("detalleNotas");
    detalle.innerHTML = "";

    alumno.evaluaciones.forEach(ev => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="cursor:pointer">${ev.nombre}</td>
            <td>${ev.fecha}</td>
            <td>${ev.nota !== null ? ev.nota : "⏳"}</td>
            <td>${calcularPromedio(alumno)}</td>
        `;

        tr.addEventListener("click", () => mostrarDescripcion(ev.descripcion));
        detalle.appendChild(tr);
    });
}

function cerrarModal() {
    document.getElementById("modal").style.display = "none";
    cerrarDescripcion();
}

/* =========================
   DESCRIPCIÓN EVALUACIÓN
========================= */
function mostrarDescripcion(texto) {
    let box = document.getElementById("descripcionBox");

    if (!box) {
        box = document.createElement("div");
        box.id = "descripcionBox";
        document.querySelector(".modal-content").appendChild(box);

        box.addEventListener("click", (e) => {
            if (window.innerWidth <= 600 && e.target === box) {
                cerrarDescripcion();
            }
        });
    }

    box.innerHTML = texto;
}

function cerrarDescripcion() {
    const box = document.getElementById("descripcionBox");
    if (box) box.remove();
}
